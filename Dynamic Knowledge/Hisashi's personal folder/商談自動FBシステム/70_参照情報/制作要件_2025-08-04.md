# リアルタイム商談アドバイザー 制作過程と追加要件

## 1. 初期実装から現在までの流れ

### 1.1 基本システムの構築
- **初期要件**: 要件.mdに基づいた基本システムの実装
- **技術スタック**: 
  - Python (FastAPI + WebSocket)
  - Google Cloud Speech-to-Text API
  - Google Gemini API（直接APIキー使用）
  - PyAudio（マイク入力）

### 1.2 認証方法の変更
- **当初**: Google Cloud Service Account認証（Vertex AI経由）
- **変更後**: Gemini API直接利用（APIキー: AIzaSyBb9u3cuNbzhjyNq8HQNUjSVl5nGOo9WCM）
- **理由**: より簡単でシンプルな実装のため

### 1.3 使用モデルの変遷
- gemini-1.5-flash → gemini-2.0-flash-exp → gemini-2.5-flash
- **最終決定**: gemini-2.5-flash（2025年8月時点の最新モデル）

## 2. 追加された機能

### 2.1 音声入力制御機能
- **要望**: 音声入力を停止・再開できるボタン
- **実装**: 
  - 赤い「音声入力を停止」ボタン
  - 緑の「音声入力を開始」ボタン
  - WebSocket経由でリアルタイム制御

### 2.2 カスタム質問機能
- **要望**: 手動で質問を入力してAIに聞けるように
- **実装**:
  - 質問入力欄（Enterキーで送信可能）
  - クイック質問ボタン（ヒアリング提案、インサイト分析、次の質問、クロージング）
  - 青い枠で質問への回答を表示

### 2.3 事前情報入力機能
- **要望**: 商談前の情報をコピペできる場所
- **実装**:
  - 黄色い背景の事前情報エリア
  - テキストエリアに自由記述
  - 「事前情報を更新」ボタンで反映
  - すべてのAI分析に事前情報が反映される

### 2.4 リアルタイム文字起こし表示
- **要望**: 音声認識された内容をリアルタイムで確認したい
- **実装**:
  - 「🎤 文字起こし（リアルタイム）」セクション
  - 新しい文字起こしは緑のボーダーでハイライト
  - フェードインアニメーション
  - 最新10件まで表示

### 2.5 音声入力の改善
- **問題**: 2秒ごとの強制処理で断片的になる
- **改善**:
  - 無音検知による文の区切り判定
  - 最小1秒〜最大10秒の動的バッファリング
  - 0.5秒の無音で文の区切りと判断
  - より自然な文章として認識

## 3. AI精度向上の施策

### 3.1 プロンプトエンジニアリング
- **初期**: 簡潔なプロンプト（トークン節約重視）
- **改善後**: 
  - 営業の5つの心構えを明示的に含める
  - 各フェーズごとの具体的アクションを詳細記載
  - JSON形式の明確な指示
  - 具体例の提供

### 3.2 トークン上限の調整
- 通常アドバイス: 500 → 1000 → 2048トークン
- カスタム質問: 300 → 500 → 1024トークン
- 生成パラメータ: top_p=0.95, top_k=64

### 3.3 エラーハンドリング
- **方針**: フォールバック処理を削除し、すべてAIに任せる
- **理由**: 定型文ではなく、常にAIが状況に応じた回答を生成

## 4. UI/UXの改善

### 4.1 レイアウト
- 左側: メイン機能（状態表示、音声制御、文字起こし、アドバイス）
- 右側: 補助機能（事前情報、顧客情報、質問機能）

### 4.2 スタイリング
- 優先度別の色分け（🔴緊急/🟡重要/🟢通常）
- アニメーション効果（フェードイン）
- レスポンシブなボタンデザイン
- 入力欄のはみ出し修正（calc(100% - 22px)）

### 4.3 ポート変更
- 8000 → 8001（既存プロセスとの競合回避）

## 5. 技術的な工夫

### 5.1 WebSocket通信
- リアルタイム双方向通信
- 音声制御コマンド: start/stop
- 質問コマンド: question
- 事前情報更新: update_prior_info

### 5.2 非同期処理
- 音声処理とAI分析を並行実行
- キューシステムで順序制御
- エラー時の自動リトライ

### 5.3 メモリ管理
- 会話履歴: 最大50ターン保持（deque使用）
- 文字起こし表示: 最新10件
- アドバイス表示: 最新10件

## 6. 今後の改善案

### 6.1 検討中の機能
- 商談の録音機能
- 商談サマリーの自動生成
- 顧客情報のエクスポート機能
- 複数商談の管理機能

### 6.2 技術的改善
- より高度な音声区切り判定
- バックグラウンドノイズの除去
- マルチユーザー対応
- データの永続化（現在はセッション限り）

## 7. 使用上の注意

### 7.1 制限事項
- サーバー再起動でデータリセット
- 単一セッションのみ対応
- インターネット接続必須
- Google Cloud APIの使用料金発生

### 7.2 推奨環境
- macOS（開発環境）
- Python 3.8以上
- Chrome/Safari（WebSocket対応ブラウザ）
- 静かな環境（音声認識精度向上のため）

## 8. 開発のポイント

### 8.1 非エンジニア向けの配慮
- 1ファイル（app.py）で完結
- 複雑な設定不要
- エラーメッセージを分かりやすく
- ステップバイステップの実行手順

### 8.2 AIアシスタント活用
- Cursor/Claude Codeでの開発を前提
- コード生成とデバッグの効率化
- ドキュメントの自動生成

この制作過程を通じて、要件定義から実装、改善まで、ユーザーフィードバックを取り入れながら段階的に機能を拡張してきました。